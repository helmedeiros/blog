{{ define "header" }}
<!-- Override header to remove title and subtitle on home page -->
{{ end }}

{{ define "main" }}
<link rel="stylesheet" href="/css/custom-layout.css">
<link rel="stylesheet" href="/css/research-style.css">

<div class="container" role="main">
    <div class="row">
    <div class="col-lg-10 col-lg-offset-1 col-md-12">

      <!-- Blog Header -->
      <div class="blog-header">
        <h1 class="blog-title">Blog</h1>

        <!-- Filter Navigation -->
        <div class="blog-filters">
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="agile">Agile</button>
            <button class="filter-tab" data-filter="events">Events</button>
            <button class="filter-tab" data-filter="leadership">Leadership</button>
            <button class="filter-tab" data-filter="architecture">Architecture</button>
          </div>

          <div class="blog-controls">
            <div class="advanced-filter-control">
              <button class="filter-btn" id="filter-btn">
                <span>Filter</span>
                <svg class="filter-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                  <path d="M9.66667 3.33333C8.93029 3.33333 8.33333 3.93029 8.33333 4.66667C8.33333 5.40305 8.93029 6 9.66667 6C10.403 6 11 5.40305 11 4.66667C11 3.93029 10.403 3.33333 9.66667 3.33333ZM7.08401 4C7.38004 2.84985 8.42411 2 9.66667 2C10.9092 2 11.9533 2.84985 12.2493 4H13.3333C13.7015 4 14 4.29848 14 4.66667C14 5.03486 13.7015 5.33333 13.3333 5.33333H12.2493C11.9533 6.48349 10.9092 7.33333 9.66667 7.33333C8.42411 7.33333 7.38004 6.48349 7.08401 5.33333H2.66667C2.29848 5.33333 2 5.03486 2 4.66667C2 4.29848 2.29848 4 2.66667 4H7.08401ZM6.33333 10C5.59695 10 5 10.597 5 11.3333C5 12.0697 5.59695 12.6667 6.33333 12.6667C7.06971 12.6667 7.66667 12.0697 7.66667 11.3333C7.66667 10.597 7.06971 10 6.33333 10ZM3.75068 10.6667C4.04671 9.51652 5.09077 8.66667 6.33333 8.66667C7.57589 8.66667 8.61996 9.51652 8.91599 10.6667H13.3333C13.7015 10.6667 14 10.9651 14 11.3333C14 11.7015 13.7015 12 13.3333 12H8.91599C8.61996 13.1502 7.57589 14 6.33333 14C5.09077 14 4.04671 13.1502 3.75068 12H2.66667C2.29848 12 2 11.7015 2 11.3333C2 10.9651 2.29848 10.6667 2.66667 10.6667H3.75068Z"/>
                </svg>
              </button>

              <!-- Advanced Filter Dropdown -->
              <div class="filter-dropdown" id="filter-dropdown">
                <div class="filter-dropdown-content">
                  <div class="filter-section">
                    <h3 class="filter-section-title">Category</h3>
                    <div class="filter-options">
                      <label class="filter-option">
                        <input type="checkbox" value="agile" data-category="category">
                        <span class="checkmark"></span>
                        Agile
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="architecture" data-category="category">
                        <span class="checkmark"></span>
                        Architecture
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="events" data-category="category">
                        <span class="checkmark"></span>
                        Events
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="leadership" data-category="category">
                        <span class="checkmark"></span>
                        Leadership
                      </label>
                    </div>
                  </div>

                  <div class="filter-section">
                    <h3 class="filter-section-title">Topic</h3>
                    <div class="filter-options">
                      <label class="filter-option">
                        <input type="checkbox" value="remote-first" data-category="topic">
                        <span class="checkmark"></span>
                        Remote-First Work
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="team building" data-category="topic">
                        <span class="checkmark"></span>
                        Team Building
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="software engineering" data-category="topic">
                        <span class="checkmark"></span>
                        Software Engineering
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="testing" data-category="topic">
                        <span class="checkmark"></span>
                        Testing & TDD
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="onboarding" data-category="topic">
                        <span class="checkmark"></span>
                        Onboarding & Growth
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="product" data-category="topic">
                        <span class="checkmark"></span>
                        Product Management
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="agile" data-category="topic">
                        <span class="checkmark"></span>
                        Agile & XP
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="culture" data-category="topic">
                        <span class="checkmark"></span>
                        Team Culture
                      </label>
                    </div>
                  </div>
                </div>

                <div class="filter-actions">
                  <button class="filter-cancel-btn" id="filter-cancel">Cancel</button>
                </div>
              </div>
            </div>

            <div class="sort-control">
              <label for="sort-select">Sort</label>
              <select id="sort-select">
                <option value="date-desc">Newest first</option>
                <option value="date-asc">Oldest first</option>
                <option value="title">Title A-Z</option>
              </select>
            </div>

            <button class="view-toggle" id="view-toggle">
              <i class="fas fa-th-list"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Posts Counter -->
      <div class="posts-counter">
        <span id="posts-count">
          {{ $allPosts := where site.RegularPages "Type" "in" site.Params.mainSections }}
          Showing {{ len $allPosts }} posts
        </span>
          </div>

                  <!-- Blog Posts -->
      <div class="blog-posts" id="blog-posts">
        {{ $allPosts := where site.RegularPages "Type" "in" site.Params.mainSections }}
        {{ range $allPosts.ByDate.Reverse }}
          <article class="post-card"
                   data-categories="{{ range .Params.categories }}{{ . | lower | replaceRE `[^a-z0-9]+` `-` }} {{ end }}"
                   data-tags="{{ range .Params.tags }}{{ . | lower }} {{ end }}"
                   data-date="{{ .Date.Format "2006-01-02" }}"
                   data-title="{{ .Title }}"
                   data-timestamp="{{ .Date.Unix }}">

            <div class="post-card-meta">
              <span class="post-card-category">
                {{ if .Params.categories }}
                  {{ index .Params.categories 0 }}
                {{ else }}
                  Publication
            {{ end }}
              </span>
              <time class="post-card-date" datetime="{{ .Date.Format "2006-01-02" }}">
                {{ .Date.Format "Jan 2, 2006" }}
              </time>
              <div class="post-card-content">
                <h2 class="post-card-title">
                  <a href="{{ .Permalink }}">{{ .Title }}</a>
                </h2>
                <div class="post-card-description">
                  {{ if .Params.description }}
                    {{ .Params.description | truncate 200 }}
                  {{ else if .Summary }}
                    {{ .Summary | plainify | truncate 200 }}
                  {{ else }}
                    {{ .Content | plainify | truncate 200 }}
            {{ end }}
                </div>
              </div>
            </div>
          </article>
        {{ end }}
      </div>



    </div>
  </div>
</div>

<script>
// Global Filter and Sort Functionality with URL Parameters
document.addEventListener('DOMContentLoaded', function() {
  const filterTabs = document.querySelectorAll('.filter-tab');
  const filterBtn = document.getElementById('filter-btn');
  const filterDropdown = document.getElementById('filter-dropdown');
  const filterCancelBtn = document.getElementById('filter-cancel');
  const sortSelect = document.getElementById('sort-select');
  const blogPosts = document.getElementById('blog-posts');
  const postCards = document.querySelectorAll('.post-card');

    // Get current URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const currentCategory = urlParams.get('category') || 'all';
  let currentSort = urlParams.get('sort') || 'date-desc';

  let activeFilters = {
    category: [],
    topic: []
  };

    // Update URL without page reload
  function updateURL() {
    const url = new URL(window.location);

    // Clear existing filter params
    url.searchParams.delete('category');
    url.searchParams.delete('topic');

    // Add selected categories
    if (activeFilters.category.length > 0) {
      url.searchParams.set('category', activeFilters.category.join(','));
    }

    // Add selected topics
    if (activeFilters.topic.length > 0) {
      url.searchParams.set('topic', activeFilters.topic.join(','));
    }

    // Add sort parameter
    if (currentSort !== 'date-desc') {
      url.searchParams.set('sort', currentSort);
    } else {
      url.searchParams.delete('sort');
    }

    // Update URL without reload
    window.history.pushState({}, '', url.toString());
  }

  // Apply filters to all posts
  function applyFilters() {
    let visibleCount = 0;

    postCards.forEach(card => {
      const cardCategories = card.dataset.categories.toLowerCase();
      let shouldShow = true;

      // Check category filters
      if (activeFilters.category.length > 0) {
        const hasCategory = activeFilters.category.some(cat =>
          cardCategories.includes(cat.toLowerCase())
        );
        if (!hasCategory) shouldShow = false;
      }

      // Check topic filters - these match against tags
      if (activeFilters.topic.length > 0 && shouldShow) {
        const cardTags = card.dataset.tags ? card.dataset.tags.toLowerCase() : '';
        const hasTopicMatch = activeFilters.topic.some(topic => {
          return cardTags.includes(topic.toLowerCase());
        });
        if (!hasTopicMatch) shouldShow = false;
      }

      if (shouldShow) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

        // Apply sorting to visible posts
    applySorting();
    updateURL();
    updateFilterButtonText();
    updateCancelButton();

    // Show filter info if filters are active
    showFilterInfo(visibleCount);

    return visibleCount;
  }

  // Apply sorting to visible posts
  function applySorting() {
    const visibleCards = Array.from(postCards).filter(card =>
      card.style.display !== 'none'
    );

    const sortedCards = visibleCards.sort((a, b) => {
      switch(currentSort) {
        case 'date-desc':
          return parseInt(b.dataset.timestamp) - parseInt(a.dataset.timestamp);
        case 'date-asc':
          return parseInt(a.dataset.timestamp) - parseInt(b.dataset.timestamp);
        case 'title':
          return a.dataset.title.localeCompare(b.dataset.title);
        default:
          return 0;
      }
    });

    // Clear container and re-append sorted visible cards
    const hiddenCards = Array.from(postCards).filter(card =>
      card.style.display === 'none'
    );

    blogPosts.innerHTML = '';
    sortedCards.forEach(card => blogPosts.appendChild(card));
    hiddenCards.forEach(card => blogPosts.appendChild(card));
  }

    // Initialize UI based on current URL parameters
  function initializeFromURL() {
    // Parse and set filters from URL
    const categoryParam = urlParams.get('category');
    const topicParam = urlParams.get('topic');

    if (categoryParam && categoryParam !== 'all') {
      activeFilters.category = categoryParam.split(',');
    }

    if (topicParam) {
      activeFilters.topic = topicParam.split(',');
    }

    // Set active tab based on URL - handle both single category and multiple
    filterTabs.forEach(tab => {
      tab.classList.remove('active');
      const tabFilter = tab.dataset.filter;

      if (tabFilter === 'all' && (!categoryParam || categoryParam === 'all')) {
        tab.classList.add('active');
      } else if (categoryParam && categoryParam.includes(tabFilter)) {
        tab.classList.add('active');
      }
    });

    // Set sort select value
    if (sortSelect) {
      sortSelect.value = currentSort;
    }

    // Update filter checkboxes and button text
    updateFilterCheckboxes();
    updateFilterButtonText();

    // Apply the filters
    applyFilters();
  }

  // Update checkbox states based on active filters
  function updateFilterCheckboxes() {
    const checkboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const category = checkbox.dataset.category;
      const value = checkbox.value;
      checkbox.checked = activeFilters[category] && activeFilters[category].includes(value);
    });
  }

  // Update filter button text
  function updateFilterButtonText() {
    const totalActiveFilters = activeFilters.category.length + activeFilters.topic.length;
    if (filterBtn) {
      const span = filterBtn.querySelector('span');
      if (span) {
        if (totalActiveFilters > 0) {
          // Get the first selected filter name
          const firstFilter = getFirstSelectedFilterName();
          if (totalActiveFilters === 1) {
            span.textContent = firstFilter;
          } else {
            span.textContent = `${firstFilter} +${totalActiveFilters - 1} more`;
          }
        } else {
          span.textContent = 'Filter';
        }
      }
    }
  }

  // Get the display name of the first selected filter
  function getFirstSelectedFilterName() {
    // Filter value to display name mapping
    const filterDisplayNames = {
      // Categories
      'agile': 'Agile',
      'architecture': 'Architecture',
      'events': 'Events',
      'leadership': 'Leadership',

      // Topics
      'remote-first': 'Remote-First Work',
      'team building': 'Team Building',
      'software engineering': 'Software Engineering',
      'testing': 'Testing & TDD',
      'onboarding': 'Onboarding & Growth',
      'product': 'Product Management',
      'culture': 'Team Culture'
    };

    // Check categories first, then topics
    if (activeFilters.category.length > 0) {
      const firstCategory = activeFilters.category[0];
      return filterDisplayNames[firstCategory] || firstCategory;
    } else if (activeFilters.topic.length > 0) {
      const firstTopic = activeFilters.topic[0];
      return filterDisplayNames[firstTopic] || firstTopic;
    }

    return 'Filter';
  }

  // Update cancel button text and behavior
  function updateCancelButton() {
    const totalActiveFilters = activeFilters.category.length + activeFilters.topic.length;
    if (filterCancelBtn) {
      if (totalActiveFilters > 0) {
        filterCancelBtn.textContent = 'Clear all';
        filterCancelBtn.className = 'filter-clear-btn';
      } else {
        filterCancelBtn.textContent = 'Cancel';
        filterCancelBtn.className = 'filter-cancel-btn';
      }
    }
  }

  // Show filter information
  function showFilterInfo(visibleCount) {
    const hasActiveFilters = activeFilters.category.length > 0 || activeFilters.topic.length > 0;

    // Remove existing filter info
    const existingInfo = document.querySelector('.filter-info');
    if (existingInfo) {
      existingInfo.remove();
    }

    if (hasActiveFilters) {
      const filterInfo = document.createElement('div');
      filterInfo.className = 'filter-info';
      filterInfo.innerHTML = `
        <div class="filter-info-content">
          <span class="filter-info-text">
            Showing ${visibleCount} filtered posts on this page.
            ${postCards.length > 50 ? '<a href="#" onclick="window.location.reload()">View all posts</a> to see complete results.' : ''}
          </span>
          <button class="filter-info-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
      `;

      // Insert after the filter controls
      const filterControls = document.querySelector('.filter-controls');
      if (filterControls) {
        filterControls.insertAdjacentElement('afterend', filterInfo);
      }
    }
  }

      // Advanced filter functionality
  function toggleFilterDropdown() {
    if (filterDropdown) {
      filterDropdown.classList.toggle('active');

      // Position dropdown responsively to avoid overflow
      if (filterDropdown.classList.contains('active')) {
        positionDropdown();
      }
    }
  }

  // Position dropdown to avoid screen overflow
  function positionDropdown() {
    if (!filterDropdown || !filterBtn) return;

    // Reset positioning classes
    filterDropdown.classList.remove('position-right');

    // Get dimensions and positions
    const dropdownRect = filterDropdown.getBoundingClientRect();
    const buttonRect = filterBtn.getBoundingClientRect();
    const viewportWidth = window.innerWidth;

    // Check if dropdown would overflow on the right
    const wouldOverflowRight = buttonRect.left + dropdownRect.width > viewportWidth - 20; // 20px margin

    // On mobile (480px and below), center the dropdown
    if (viewportWidth <= 480) {
      // Centering is handled by CSS transform
      return;
    }

    // On larger screens, position left or right based on available space
    if (wouldOverflowRight) {
      filterDropdown.classList.add('position-right');
    }
  }

  function applyAdvancedFilters() {
    const checkboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
    activeFilters = { category: [], topic: [] };

    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const category = checkbox.dataset.category;
        activeFilters[category].push(checkbox.value);
      }
    });

    // Update tab states - clear all first
    filterTabs.forEach(tab => tab.classList.remove('active'));

    // If only one category selected, highlight that tab
    if (activeFilters.category.length === 1) {
      const singleCategory = activeFilters.category[0];
      filterTabs.forEach(tab => {
        if (tab.dataset.filter === singleCategory) {
          tab.classList.add('active');
        }
      });
    } else if (activeFilters.category.length === 0) {
      // No categories selected, show "All" as active
      filterTabs.forEach(tab => {
        if (tab.dataset.filter === 'all') {
          tab.classList.add('active');
        }
      });
    }

    // Apply the filters
    applyFilters();
  }

  function clearAdvancedFilters() {
    activeFilters = { category: [], topic: [] };

    // Update checkboxes
    const checkboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);

    // Set "All" tab as active
    filterTabs.forEach(tab => {
      tab.classList.remove('active');
      if (tab.dataset.filter === 'all') {
        tab.classList.add('active');
      }
    });

    // Apply filters (will show all posts)
    applyFilters();
  }

  function handleCancelClick() {
    const totalActiveFilters = activeFilters.category.length + activeFilters.topic.length;

    if (totalActiveFilters > 0) {
      // Clear all filters
      clearAdvancedFilters();
    } else {
      // Just close the dropdown
      if (filterDropdown) {
        filterDropdown.classList.remove('active');
      }
      if (filterBtn) {
        filterBtn.classList.remove('active');
      }
    }
  }

  // Tab click handlers
  filterTabs.forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      const filter = this.dataset.filter;

      // Clear advanced filters and set single category
      activeFilters = { category: [], topic: [] };

      if (filter !== 'all') {
        activeFilters.category = [filter];
      }

      // Update tab states
      filterTabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');

      // Update checkboxes
      updateFilterCheckboxes();

      // Apply filters
      applyFilters();
    });
  });

  // Advanced filter event handlers
  if (filterBtn) {
    filterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleFilterDropdown();
      filterBtn.classList.toggle('active');
    });
  }

  // Add event listeners to checkboxes for immediate filtering
  const checkboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      applyAdvancedFilters();
    });
  });

  if (filterCancelBtn) {
    filterCancelBtn.addEventListener('click', handleCancelClick);
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (filterDropdown && !filterDropdown.contains(e.target) && filterBtn && !filterBtn.contains(e.target)) {
      filterDropdown.classList.remove('active');
      filterBtn.classList.remove('active');
    }
  });

  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      currentSort = this.value;
      applySorting();
      updateURL();
    });
  }

  // Handle window resize to reposition dropdown if open
  window.addEventListener('resize', function() {
    if (filterDropdown && filterDropdown.classList.contains('active')) {
      positionDropdown();
    }
  });

  // Initialize the UI from URL parameters
  initializeFromURL();
});
</script>

{{ end }}
