{{ define "header" }}
<!-- Override header to remove title and subtitle on home page -->
{{ end }}

{{ define "main" }}
<link rel="stylesheet" href="/css/custom-layout.css">
<link rel="stylesheet" href="/css/research-style.css">

<div class="container" role="main">
    <div class="row">
    <div class="col-lg-10 col-lg-offset-1 col-md-12">

      <!-- Blog Header -->
      <div class="blog-header">
        <h1 class="blog-title">Blog</h1>

        <!-- Filter Navigation -->
        <div class="blog-filters">
          <div class="filter-tabs">
            <button class="filter-tab active" data-filter="all">All</button>
            <button class="filter-tab" data-filter="agile">Agile</button>
            <button class="filter-tab" data-filter="events">Events</button>
            <button class="filter-tab" data-filter="leadership">Leadership</button>
            <button class="filter-tab" data-filter="architecture">Architecture</button>
          </div>

          <div class="blog-controls">
            <div class="advanced-filter-control">
              <button class="filter-btn" id="filter-btn">
                <span>Filter</span>
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path d="M3 6h10M5 10h6M7 14h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                </svg>
              </button>

              <!-- Advanced Filter Dropdown -->
              <div class="filter-dropdown" id="filter-dropdown">
                <div class="filter-dropdown-content">
                  <div class="filter-section">
                    <h3 class="filter-section-title">Category</h3>
                    <div class="filter-options">
                      <label class="filter-option">
                        <input type="checkbox" value="agile" data-category="category">
                        <span class="checkmark"></span>
                        Agile
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="architecture" data-category="category">
                        <span class="checkmark"></span>
                        Architecture
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="events" data-category="category">
                        <span class="checkmark"></span>
                        Events
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="leadership" data-category="category">
                        <span class="checkmark"></span>
                        Leadership
                      </label>
                    </div>
                  </div>

                  <div class="filter-section">
                    <h3 class="filter-section-title">Topic</h3>
                    <div class="filter-options">
                      <label class="filter-option">
                        <input type="checkbox" value="scrum" data-category="topic">
                        <span class="checkmark"></span>
                        Scrum & Methodologies
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="design-patterns" data-category="topic">
                        <span class="checkmark"></span>
                        Design Patterns
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="team-building" data-category="topic">
                        <span class="checkmark"></span>
                        Team Building
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="conferences" data-category="topic">
                        <span class="checkmark"></span>
                        Conferences & Talks
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="product-management" data-category="topic">
                        <span class="checkmark"></span>
                        Product Management
                      </label>
                      <label class="filter-option">
                        <input type="checkbox" value="software-development" data-category="topic">
                        <span class="checkmark"></span>
                        Software Development
                      </label>
                    </div>
                  </div>

                  <div class="filter-actions">
                    <button class="filter-clear-btn" id="filter-clear">Clear all</button>
                    <button class="filter-apply-btn" id="filter-apply">Apply filters</button>
                  </div>
                </div>
              </div>
            </div>

            <div class="sort-control">
              <label for="sort-select">Sort</label>
              <select id="sort-select">
                <option value="date-desc">Newest first</option>
                <option value="date-asc">Oldest first</option>
                <option value="title">Title A-Z</option>
              </select>
            </div>

            <button class="view-toggle" id="view-toggle">
              <i class="fas fa-th-list"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Posts Counter -->
      <div class="posts-counter">
        <span id="posts-count">
          {{ $allPosts := where site.RegularPages "Type" "in" site.Params.mainSections }}
          Showing {{ len $allPosts }} posts
        </span>
          </div>

                  <!-- Blog Posts -->
      <div class="blog-posts" id="blog-posts">
        {{ $allPosts := where site.RegularPages "Type" "in" site.Params.mainSections }}
        {{ range $allPosts.ByDate.Reverse }}
          <article class="post-card"
                   data-categories="{{ range .Params.categories }}{{ . | lower | replaceRE `[^a-z0-9]+` `-` }} {{ end }}"
                   data-date="{{ .Date.Format "2006-01-02" }}"
                   data-title="{{ .Title }}"
                   data-timestamp="{{ .Date.Unix }}">

            <div class="post-card-meta">
              <span class="post-card-category">
                {{ if .Params.categories }}
                  {{ index .Params.categories 0 }}
                {{ else }}
                  Publication
            {{ end }}
              </span>
              <time class="post-card-date" datetime="{{ .Date.Format "2006-01-02" }}">
                {{ .Date.Format "Jan 2, 2006" }}
              </time>
              <div class="post-card-content">
                <h2 class="post-card-title">
                  <a href="{{ .Permalink }}">{{ .Title }}</a>
                </h2>
                <div class="post-card-description">
                  {{ if .Params.description }}
                    {{ .Params.description | truncate 200 }}
                  {{ else if .Summary }}
                    {{ .Summary | plainify | truncate 200 }}
                  {{ else }}
                    {{ .Content | plainify | truncate 200 }}
            {{ end }}
                </div>
              </div>
            </div>
          </article>
        {{ end }}
      </div>



    </div>
  </div>
</div>

<script>
// Global Filter and Sort Functionality with URL Parameters
document.addEventListener('DOMContentLoaded', function() {
  const filterTabs = document.querySelectorAll('.filter-tab');
  const filterBtn = document.getElementById('filter-btn');
  const filterDropdown = document.getElementById('filter-dropdown');
  const filterClearBtn = document.getElementById('filter-clear');
  const filterApplyBtn = document.getElementById('filter-apply');
  const sortSelect = document.getElementById('sort-select');
  const blogPosts = document.getElementById('blog-posts');
  const postCards = document.querySelectorAll('.post-card');

    // Get current URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const currentCategory = urlParams.get('category') || 'all';
  let currentSort = urlParams.get('sort') || 'date-desc';

  let activeFilters = {
    category: [],
    topic: []
  };

    // Update URL without page reload
  function updateURL() {
    const url = new URL(window.location);

    // Clear existing filter params
    url.searchParams.delete('category');
    url.searchParams.delete('topic');

    // Add selected categories
    if (activeFilters.category.length > 0) {
      url.searchParams.set('category', activeFilters.category.join(','));
    }

    // Add selected topics
    if (activeFilters.topic.length > 0) {
      url.searchParams.set('topic', activeFilters.topic.join(','));
    }

    // Add sort parameter
    if (currentSort !== 'date-desc') {
      url.searchParams.set('sort', currentSort);
    } else {
      url.searchParams.delete('sort');
    }

    // Update URL without reload
    window.history.pushState({}, '', url.toString());
  }

  // Apply filters to all posts
  function applyFilters() {
    let visibleCount = 0;

    postCards.forEach(card => {
      const cardCategories = card.dataset.categories.toLowerCase();
      let shouldShow = true;

      // Check category filters
      if (activeFilters.category.length > 0) {
        const hasCategory = activeFilters.category.some(cat =>
          cardCategories.includes(cat.toLowerCase())
        );
        if (!hasCategory) shouldShow = false;
      }

      // Check topic filters (basic implementation)
      if (activeFilters.topic.length > 0 && shouldShow) {
        const hasTopicMatch = activeFilters.topic.some(topic => {
          return cardCategories.includes(topic.toLowerCase()) ||
                 card.textContent.toLowerCase().includes(topic.toLowerCase());
        });
        if (!hasTopicMatch) shouldShow = false;
      }

      if (shouldShow) {
        card.style.display = 'block';
        visibleCount++;
      } else {
        card.style.display = 'none';
      }
    });

        // Apply sorting to visible posts
    applySorting();
    updateURL();
    updateFilterButtonText();

    // Show filter info if filters are active
    showFilterInfo(visibleCount);

    return visibleCount;
  }

  // Apply sorting to visible posts
  function applySorting() {
    const visibleCards = Array.from(postCards).filter(card =>
      card.style.display !== 'none'
    );

    const sortedCards = visibleCards.sort((a, b) => {
      switch(currentSort) {
        case 'date-desc':
          return parseInt(b.dataset.timestamp) - parseInt(a.dataset.timestamp);
        case 'date-asc':
          return parseInt(a.dataset.timestamp) - parseInt(b.dataset.timestamp);
        case 'title':
          return a.dataset.title.localeCompare(b.dataset.title);
        default:
          return 0;
      }
    });

    // Clear container and re-append sorted visible cards
    const hiddenCards = Array.from(postCards).filter(card =>
      card.style.display === 'none'
    );

    blogPosts.innerHTML = '';
    sortedCards.forEach(card => blogPosts.appendChild(card));
    hiddenCards.forEach(card => blogPosts.appendChild(card));
  }

    // Initialize UI based on current URL parameters
  function initializeFromURL() {
    // Parse and set filters from URL
    const categoryParam = urlParams.get('category');
    const topicParam = urlParams.get('topic');

    if (categoryParam && categoryParam !== 'all') {
      activeFilters.category = categoryParam.split(',');
    }

    if (topicParam) {
      activeFilters.topic = topicParam.split(',');
    }

    // Set active tab based on URL - handle both single category and multiple
    filterTabs.forEach(tab => {
      tab.classList.remove('active');
      const tabFilter = tab.dataset.filter;

      if (tabFilter === 'all' && (!categoryParam || categoryParam === 'all')) {
        tab.classList.add('active');
      } else if (categoryParam && categoryParam.includes(tabFilter)) {
        tab.classList.add('active');
      }
    });

    // Set sort select value
    if (sortSelect) {
      sortSelect.value = currentSort;
    }

    // Update filter checkboxes and button text
    updateFilterCheckboxes();
    updateFilterButtonText();

    // Apply the filters
    applyFilters();
  }

  // Update checkbox states based on active filters
  function updateFilterCheckboxes() {
    const checkboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
      const category = checkbox.dataset.category;
      const value = checkbox.value;
      checkbox.checked = activeFilters[category] && activeFilters[category].includes(value);
    });
  }

  // Update filter button text
  function updateFilterButtonText() {
    const totalActiveFilters = activeFilters.category.length + activeFilters.topic.length;
    if (filterBtn) {
      const span = filterBtn.querySelector('span');
      if (span) {
        if (totalActiveFilters > 0) {
          span.textContent = `Filter (${totalActiveFilters})`;
        } else {
          span.textContent = 'Filter';
        }
      }
    }
  }

  // Show filter information
  function showFilterInfo(visibleCount) {
    const hasActiveFilters = activeFilters.category.length > 0 || activeFilters.topic.length > 0;

    // Remove existing filter info
    const existingInfo = document.querySelector('.filter-info');
    if (existingInfo) {
      existingInfo.remove();
    }

    if (hasActiveFilters) {
      const filterInfo = document.createElement('div');
      filterInfo.className = 'filter-info';
      filterInfo.innerHTML = `
        <div class="filter-info-content">
          <span class="filter-info-text">
            Showing ${visibleCount} filtered posts on this page.
            ${postCards.length > 50 ? '<a href="#" onclick="window.location.reload()">View all posts</a> to see complete results.' : ''}
          </span>
          <button class="filter-info-close" onclick="this.parentElement.parentElement.remove()">×</button>
        </div>
      `;

      // Insert after the filter controls
      const filterControls = document.querySelector('.filter-controls');
      if (filterControls) {
        filterControls.insertAdjacentElement('afterend', filterInfo);
      }
    }
  }

      // Advanced filter functionality
  function toggleFilterDropdown() {
    if (filterDropdown) {
      filterDropdown.classList.toggle('active');
    }
  }

  function applyAdvancedFilters() {
    const checkboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
    activeFilters = { category: [], topic: [] };

    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const category = checkbox.dataset.category;
        activeFilters[category].push(checkbox.value);
      }
    });

    // Update tab states - clear all first
    filterTabs.forEach(tab => tab.classList.remove('active'));

    // If only one category selected, highlight that tab
    if (activeFilters.category.length === 1) {
      const singleCategory = activeFilters.category[0];
      filterTabs.forEach(tab => {
        if (tab.dataset.filter === singleCategory) {
          tab.classList.add('active');
        }
      });
    } else if (activeFilters.category.length === 0) {
      // No categories selected, show "All" as active
      filterTabs.forEach(tab => {
        if (tab.dataset.filter === 'all') {
          tab.classList.add('active');
        }
      });
    }

    // Apply the filters
    applyFilters();

    // Close dropdown
    if (filterDropdown) {
      filterDropdown.classList.remove('active');
    }
  }

  function clearAdvancedFilters() {
    activeFilters = { category: [], topic: [] };

    // Update checkboxes
    const checkboxes = document.querySelectorAll('.filter-dropdown input[type="checkbox"]');
    checkboxes.forEach(checkbox => checkbox.checked = false);

    // Set "All" tab as active
    filterTabs.forEach(tab => {
      tab.classList.remove('active');
      if (tab.dataset.filter === 'all') {
        tab.classList.add('active');
      }
    });

    // Apply filters (will show all posts)
    applyFilters();
  }

  // Tab click handlers
  filterTabs.forEach(tab => {
    tab.addEventListener('click', function(e) {
      e.preventDefault();
      const filter = this.dataset.filter;

      // Clear advanced filters and set single category
      activeFilters = { category: [], topic: [] };

      if (filter !== 'all') {
        activeFilters.category = [filter];
      }

      // Update tab states
      filterTabs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');

      // Update checkboxes
      updateFilterCheckboxes();

      // Apply filters
      applyFilters();
    });
  });

  // Advanced filter event handlers
  if (filterBtn) {
    filterBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleFilterDropdown();
    });
  }

  if (filterApplyBtn) {
    filterApplyBtn.addEventListener('click', applyAdvancedFilters);
  }
  if (filterClearBtn) {
    filterClearBtn.addEventListener('click', clearAdvancedFilters);
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', function(e) {
    if (filterDropdown && !filterDropdown.contains(e.target) && filterBtn && !filterBtn.contains(e.target)) {
      filterDropdown.classList.remove('active');
    }
  });

  if (sortSelect) {
    sortSelect.addEventListener('change', function() {
      currentSort = this.value;
      applySorting();
      updateURL();
    });
  }

  // Initialize the UI from URL parameters
  initializeFromURL();
});
</script>

{{ end }}
